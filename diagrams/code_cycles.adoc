:backend: revealjs
:revealjs_theme: white
:customcss: common.css
:revealjs_transition: none

=== Как хорошо, что все мы здесь...
["graphviz", "code_cycle", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Jenkins[label="code"];
  Jenkins -> Artifactory[label="jar-file"];
}
---------------------------------------------------------------------

=== Как хорошо, что все мы здесь...
----
try {
        stage ('Exec Maven') {
            rtMaven.run pom: 'pom.xml', goals: 'clean install', buildInfo: buildInfo
        }
    } finally {
        junit '**/surefire-reports/**/*.xml'
        step( [ $class: 'JacocoPublisher', execPattern: 'target/jacoco.exec' ] )
        checkstyle pattern: 'target/checkstyle-result.xml'
    }
if (isRelease) {
            stage ('Publish build info') {
                server.publishBuildInfo buildInfo
            }
----

=== Там, в красном уголке
["graphviz", "image_cycle", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Jenkins[label="code"];
  Artifactory -> Jenkins[label="jar-file"];
  Jenkins -> Artifactory[label="docker-image"];
}
---------------------------------------------------------------------

=== Там, в красном уголке
----
stage ('Build and publish docker container') {
    env.RELEASE_VERSION = releaseVersion
    sh 'docker build . -t artifactory.corchestra.ru/docker/$JOB_NAME:$RELEASE_VERSION --build-arg version=$RELEASE_VERSION'
    sh 'docker push artifactory.corchestra.ru/docker/$JOB_NAME:$RELEASE_VERSION'
}
----

=== Почему докер?
[%step]
* Урезать рацион
* Легко масштабировать
* Упал - перезапустился
* Изоляция окружения

=== Борьба за зависимости
["graphviz", "chart_cycle", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Jenkins[label="code"];
  Jenkins -> Artifactory[label="chart"]
}
---------------------------------------------------------------------

=== Борьба за зависимости
----
stage ('Package and index repo') {
    sh 'helm init --client-only'
    sh 'helm repo add cp-helm-charts https://confluentinc.github.io/cp-helm-charts'
    sh 'helm dependency update melbet'
    sh 'helm package melbet | true'
    sh 'helm repo index .'
    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'Artifactory_ansible_user',
            usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
        sh 'curl -u $USERNAME:$PASSWORD -T melbet-0.1.0.tgz https://artifactory.corchestra.ru/artifactory/helm/'
        sh 'curl -u $USERNAME:$PASSWORD -T index.yaml https://artifactory.corchestra.ru/artifactory/helm/'
    }
}
----

=== Почему helm?
[%step]
* Пакетный менеджер для сервисов k8s
* Cloud Native Computing Foundation
* Большое количество готовых пакетов для классического web
* Скоро будет Helm 3 без детских болезней(уже есть альфа)
* Достаточно выбрать другой namespace, и будет dev, test, staging, prod

=== Инфраструктура тоже здесь
["graphviz", "infra_cycle", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Atlantis[label="tf"];
  Artifactory -> cloud_provider[label="images, charts"];
  Atlantis -> cloud_provider[label="tf, creds"];
  Atlantis -> Artifactory[label="tfstate"];
}
---------------------------------------------------------------------

=== Инфраструктура тоже здесь
----
version: 2
projects:
- name: betsource
  dir: .
  workspace: default
  terraform_version: v0.11.13
  autoplan:
    when_modified: ["*.tf", "./modules/**/*.tf"]
  apply_requirements: [approved]
  workflow: betsource
workflows:
  betsource:
    plan:
      steps:
      - init:
          extra_args: ["-backend-config=/opt/Artifactory.tfvars"]
      - plan:
          extra_args: ["-lock=false", "-var-file", "/opt/kubecluster.tfvars"]
    apply:
      steps:
      - apply
----

=== Некосмический корабль
["graphviz", "Atlantis_1", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Atlantis[label="webhook",color=red]
  GitHub -> Atlantis[label="tf-file",color=red]
  GitHub -> Atlantis[label="apply"]
  Atlantis -> cloud_provider[label="infrastructure"]
  Atlantis -> backend[label="tfstate"]
  backend -> Atlantis[label="tfstate"]
  Atlantis -> GitHub[label="output"]
}
---------------------------------------------------------------------

=== Некосмический корабль
["graphviz", "Atlantis_2", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Atlantis[label="webhook"]
  GitHub -> Atlantis[label="tf-file"]
  GitHub -> Atlantis[label="apply"]
  Atlantis -> cloud_provider[label="infrastructure"]
  Atlantis -> backend[label="tfstate"]
  backend -> Atlantis[label="tfstate",color=red]
  Atlantis -> GitHub[label="output",color=red]
}
---------------------------------------------------------------------

=== Некосмический корабль
["graphviz", "Atlantis_3", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Atlantis[label="webhook"]
  GitHub -> Atlantis[label="tf-file"]
  GitHub -> Atlantis[label="apply",color=red]
  Atlantis -> cloud_provider[label="infrastructure"]
  Atlantis -> backend[label="tfstate"]
  backend -> Atlantis[label="tfstate"]
  Atlantis -> GitHub[label="output"]
}
---------------------------------------------------------------------

=== Некосмический корабль
["graphviz", "Atlantis_4", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub -> Atlantis[label="webhook"]
  GitHub -> Atlantis[label="tf-file"]
  Atlantis -> cloud_provider[label="infrastructure",color=red]
  Atlantis -> backend[label="tfstate",color=red]
  GitHub -> Atlantis[label="apply"]
  backend -> Atlantis[label="tfstate"]
  Atlantis -> GitHub[label="output",color=red]
}
---------------------------------------------------------------------

=== Atlantis - IaC автоматизация прямо из VCS
image::images/hero.png[]

=== Не будем отвлекаться
["graphviz", "all_cycle", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub;
  Atlantis;
  cloud_provider;
  GitHub -> Jenkins[label="code"];
  Jenkins -> Artifactory[label="jar-file"];
  Artifactory -> Jenkins[label="jar-file"];
  Jenkins -> Artifactory[label="image"];
  Jenkins -> Artifactory[label="chart"];
  GitHub -> Atlantis[label="tf"];
  Artifactory -> cloud_provider[label="docker-image, chart"];
  Atlantis -> cloud_provider[label="tf, creds, helm"];
  Atlantis -> Artifactory[label="tfstate"];
}
---------------------------------------------------------------------

=== Не будем отвлекаться
["graphviz", "all_cycle_interest", "svg"]
---------------------------------------------------------------------
digraph main {
  rankdir = LR;
  GitHub[color=blue];
  Atlantis[color=blue];
  cloud_provider[color=blue];
  GitHub -> Jenkins[label="code"];
  Jenkins -> Artifactory[label="jar-file"];
  Artifactory -> Jenkins[label="jar-file"];
  Jenkins -> Artifactory[label="image"];
  Jenkins -> Artifactory[label="chart"];
  GitHub -> Atlantis[label="tf",color=blue];
  Artifactory -> cloud_provider[label="docker-image, chart"];
  Atlantis -> cloud_provider[label="tf, creds, helm",color=blue];
  Atlantis -> Artifactory[label="tfstate"];
}
---------------------------------------------------------------------
