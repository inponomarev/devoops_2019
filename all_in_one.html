<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="author" content="Как маленькой команде успешно управлять немаленькой инфраструктурой."><title>Квадратно-гнездовое мышление как образ жизни</title><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"><link href="reveal.js/css/reveal.css" rel="stylesheet"><link rel="stylesheet" href="reveal.js/css/theme/white.css" id="theme"><!--This CSS is generated by the Asciidoctor-Reveal.js converter to further integrate AsciiDoc's existing semantic with Reveal.js--><style type="text/css">.reveal div.right {
  float: right;
}

/* callouts */
.conum[data-value] {display:inline-block;color:#fff!important;background-color:rgba(50,150,50,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}</style><link href="reveal.js/lib/css/zenburn.css" rel="stylesheet"><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js/css/print/pdf.css" : "reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><!--[if lt IE 9]><script src="reveal.js/lib/js/html5shiv.js"></script><![endif]--><link rel="stylesheet" href="common.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Квадратно-гнездовое мышление как образ жизни</h1><p class="author"><small>Как маленькой команде успешно управлять немаленькой инфраструктурой.</small></p></section><section><div class="dlist"><dl><dt class="hdlist1">Имя</dt><dd><p>Дмитрий Губенко, КУРС</p></dd><dt class="hdlist1">Почта</dt><dd><p><a href="mailto:dmeatriy@gmail.com">dmeatriy@gmail.com</a></p></dd><dt class="hdlist1">Telegram</dt><dd><p>@Dmeatriy</p></dd></dl></div></section>
<section id="_когда_каждый_может_обидеть"><h2>Когда каждый может обидеть</h2><div class="imageblock" style=""><img src="images/david_&_goliaf.jpg" alt="david & goliaf"></div></section>
<section id="_что_имеем_на_входе"><h2>Что имеем на входе?</h2><div class="ulist"><ul><li class="fragment"><p>Облачный провайдер - DigitalOcean</p></li><li class="fragment"><p>Terraform</p><div class="ulist"><ul><li><p>~1000 строк провайдер-ориентированного кода</p></li><li><p>~100 виртуальных машин</p></li><li><p>~20 dns-записей</p></li></ul></div></li><li class="fragment"><p>Ansible</p><div class="ulist"><ul><li><p>~5000 строк кода</p></li><li><p>~20 плейбуков с пачкой ролей</p></li></ul></div></li></ul></div></section>
<section id="_что_болит"><h2>Что болит?</h2><div class="ulist"><ul><li class="fragment"><p>Нет быстрого способа переехать к другому провайдеру.</p></li><li class="fragment"><p>МНОГО кода для деплоя</p></li><li class="fragment"><p>Отвратительное масштабирование системы.</p></li><li class="fragment"><p>Деплой тоже требует дебага.</p></li><li class="fragment"><p>Соблюдение идемпотентности.</p></li><li class="fragment"><p>Кто ходил на мою ноду?</p></li></ul></div></section>
<section id="_ansible_fu"><h2>Ansible-fu?</h2><div class="ulist"><ul><li class="fragment"><p>Управление inventory для ansible</p></li><li class="fragment"><p>Конфигурационный ад.</p></li><li class="fragment"><p>Управление сервисами при обновлении.</p></li><li class="fragment"><p>Зависимость от операционной системы.</p></li></ul></div></section>
<section id="_погнали_по_пунктам"><h2>Погнали по пунктам?</h2><div class="imageblock" style=""><img src="images/the_roof_is_on_fire.jpg" alt="the roof is on fire"></div></section>
<section><div class="paragraph"><p>Оставь меня, я задержу их.</p></div>
<pre class="highlight listingblock"><code>resource "digitalocean_droplet" "pgdb-dev" {
    image = "31754481"
    name = "pgdb-dev"
    region = "ams2"
    size = "s-2vcpu-2gb"
    private_networking = "true"
    resize_disk = "false"
    ssh_keys = ["${var.ssh_keys}"]
    user_data = "${file("minimal.conf")}"
}</code></pre>
<div class="ulist"><ul><li class="fragment"><p>Ах, если бы только ноды.</p></li></ul></div></section>
<section><div class="paragraph"><p>Посыпьте их пеплом</p></div>
<pre class="highlight listingblock"><code>variable "eps_names" { default = ["epsilon400",
                                  "epsilon401",
                                  "epsilon402",
                                  "epsilon403",
                                  "epsilon404",
                                  "epsilon405"] }</code></pre>
<div class="ulist"><ul><li class="fragment"><p>Когда в твою инфраструктуру попадает цикл.</p></li></ul></div></section>
<section><div class="paragraph"><p>Когда каждый ansible-playbook - произведение искусства.</p></div>
<pre class="highlight listingblock"><code>---
- name: configure backoffice server
... 10 more lines
  roles:
    - role: do_hostname
... 20 more lines
    - role: backoffice
  tasks:
... 50 more lines
    - name: Reload nginx
      service:
        name: nginx
        state: reloaded</code></pre>
<div class="ulist"><ul><li class="fragment"><p>Долго, дорого, будет цениться после смерти автора(нет).</p></li></ul></div></section>
<section><section id="_а_что_собственно_деплоим"><h2>А что, собственно, деплоим?</h2><div class="imageblock" style=""><img src="main_scheme.svg" alt="main scheme"></div></section><section><div class="imageblock" style=""><img src="code_cycle.svg" alt="code cycle"></div></section><section><pre class="highlight listingblock"><code>try {
        stage ('Exec Maven') {
            rtMaven.run pom: 'pom.xml', goals: 'clean install', buildInfo: buildInfo
        }
    } finally {
        junit '**/surefire-reports/**/*.xml'
        step( [ $class: 'JacocoPublisher', execPattern: 'target/jacoco.exec' ] )
        checkstyle pattern: 'target/checkstyle-result.xml'
    }</code></pre></section><section><div class="imageblock" style=""><img src="image_cycle.svg" alt="image cycle"></div></section><section><pre class="highlight listingblock"><code>stage ('Build and publish docker container') {
    env.RELEASE_VERSION = releaseVersion
    sh 'docker build . -t artifactory.corchestra.ru/docker/$JOB_NAME:$RELEASE_VERSION --build-arg version=$RELEASE_VERSION'
    sh 'docker push artifactory.corchestra.ru/docker/$JOB_NAME:$RELEASE_VERSION'
}</code></pre></section><section><div class="imageblock" style=""><img src="chart_cycle.svg" alt="chart cycle"></div></section><section><pre class="highlight listingblock"><code>stage ('Package and index repo') {
    sh 'helm init --client-only'
    sh 'helm repo add cp-helm-charts https://confluentinc.github.io/cp-helm-charts'
    sh 'helm dependency update melbet'
    sh 'helm package melbet | true'
    sh 'helm repo index .'
    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'artifactory_ansible_user',
            usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
        sh 'curl -u $USERNAME:$PASSWORD -T melbet-0.1.0.tgz https://artifactory.corchestra.ru/artifactory/helm/'
        sh 'curl -u $USERNAME:$PASSWORD -T index.yaml https://artifactory.corchestra.ru/artifactory/helm/'
    }
}</code></pre></section><section><div class="imageblock" style=""><img src="infra_cycle.svg" alt="infra cycle"></div></section><section><pre class="highlight listingblock"><code>version: 2
projects:
- name: betsource
  dir: .
  workspace: default
  terraform_version: v0.11.13
  autoplan:
    when_modified: ["*.tf", "./modules/**/*.tf"]
  apply_requirements: [approved]
  workflow: betsource
workflows:
  betsource:
    plan:
      steps:
      - init:
          extra_args: ["-backend-config=/opt/artifactory.tfvars"]
      - plan:
          extra_args: ["-lock=false", "-var-file", "/opt/kubecluster.tfvars"]
    apply:
      steps:
      - apply</code></pre></section><section><div class="imageblock" style=""><img src="all_cycle.svg" alt="all cycle"></div></section></section>
<section><section id="_я_рассажу_вас_по_стульчикам"><h2>Я рассажу вас по стульчикам.</h2><div class="imageblock" style=""><img src="images/before_k8s_after_k8s.jpg" alt="before k8s after k8s"></div></section><section data-transition="none"><div class="imageblock" style=""><img src="terraform_initial1.svg" alt="terraform initial1"></div></section><section><div class="imageblock" style=""><img src="terraform_initial2.svg" alt="terraform initial2"></div></section><section><div class="imageblock" style=""><img src="terraform_initial3.svg" alt="terraform initial3"></div></section><section><div class="imageblock" style=""><img src="terraform_initial4.svg" alt="terraform initial4"></div></section><section><div class="imageblock" style=""><img src="terraform_initial5.svg" alt="terraform initial5"></div></section><section><div class="imageblock" style=""><img src="terraform_initial6.svg" alt="terraform initial6"></div></section><section><div class="imageblock" style=""><img src="terraform_initial7.svg" alt="terraform initial7"></div></section></section>
<section id="_хорошо_всё_кроме_одной_вещи"><h2>Хорошо всё, кроме одной вещи.</h2><div class="ulist"><ul><li class="fragment"><p>Правая рука не знает, что делает левая.</p></li></ul></div></section>
<section><section id="_из_пушки_по_воробьям"><h2>Из пушки по воробьям?</h2><div class="ulist"><ul><li class="fragment"><p>Добавить/убавить ноду в пул.</p></li><li class="fragment"><p>Пробросить dns-запись.</p></li><li class="fragment"><p>Настроить load-balancing.</p></li><li class="fragment"><p>Завесить сертификат на ingress.</p></li></ul></div></section><section><div class="imageblock" style=""><img src="terraform_kubernetes.svg" alt="terraform kubernetes"></div></section><section><div class="imageblock" style=""><img src="terraform_kubernetes1.svg" alt="terraform kubernetes1"></div></section><section><pre class="highlight listingblock"><code>odds-api:
  image:
    tag: 1.0.5
  nodeSelector:
    cloud.google.com/gke-nodepool: support-pool
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
    hosts:
      - host: odds-api.888totobet.com
        paths:
         - "/"</code></pre></section><section><pre class="highlight listingblock"><code>nginx-ingress:
  controller:
    nodeSelector:
      cloud.google.com/gke-nodepool: support-pool
    service:
      annotations:
        external-dns.alpha.kubernetes.io/hostname: grafana.888totobet.com, odds-api.888totobet.com, kibana.888totobet.com
  default-backend:
    nodeSelector:
      cloud.google.com/gke-nodepool: support-pool</code></pre></section><section><pre class="highlight listingblock"><code>external-dns:
  provider: digitalocean
  digitalocean:
    apiToken: "very_secret_api_token"
  rbac:
    create: true
  sources:
    - service
  logLevel: info
  publishInternalServices: true
  registry: noop</code></pre></section><section id="_здесь_должен_быть_код_для_cert_manager"><h2>Здесь должен быть код для cert-manager</h2></section><section id="_здесь_должен_быть_код_для_cluster_autoscaler"><h2>Здесь должен быть код для cluster-autoscaler</h2></section><section><div class="imageblock" style=""><img src="terraform_kubernetes2.svg" alt="terraform kubernetes2"></div></section><section><div class="imageblock" style=""><img src="terraform_kubernetes3.svg" alt="terraform kubernetes3"></div></section></section>
<section id="_почему_это_удобно"><h2>Почему это удобно?</h2><div class="ulist"><ul><li class="fragment"><p>Всё находится в default values.yml в чарте.</p></li><li class="fragment"><p>И инфраструктура тоже.</p></li><li class="fragment"><p>И ничего из этого не попадает в tf файл.</p></li></ul></div></section>
<section id="_добавим_немного_красоты"><h2>Добавим немного красоты</h2><div class="imageblock" style=""><img src="main_scheme1.svg" alt="main scheme1"></div></section>
<section><section id="_terraform_как_способ_инициализации"><h2>Terraform как способ инициализации.</h2></section><section><pre class="highlight listingblock"><code>resource "digitalocean_kubernetes_cluster" "melbet2" {
  name    = "melbet"
  region  = "lon1"
  version = "1.14.2-do.0"

  node_pool {
    name       = "puppetheatre-pool"
    size       = "s-4vcpu-8gb"
    node_count = 10
    tags       = ["puppetheatre"]
  }

}</code></pre></section><section><div class="paragraph"><p>Итого: 144 строки для DigitalOcean</p></div></section><section><pre class="highlight listingblock"><code>resource "google_container_cluster" "melbet" {
  name               = "melbet-cluster"
  location               = "europe-north1-a"
  remove_default_node_pool = true
  initial_node_count = 1

  // Use legacy ABAC until these issues are resolved:
  //   https://github.com/mcuadros/terraform-provider-helm/issues/56
  //   https://github.com/terraform-providers/terraform-provider-kubernetes/pull/73
  enable_legacy_abac = true

  // Wait for the GCE LB controller to cleanup the resources.
  provisioner "local-exec" {
    when    = "destroy"
    command = "sleep 90"
  }
}</code></pre></section><section><div class="paragraph"><p>Итого: 149 строк для GCP</p></div></section></section></div></div><script src="reveal.js/lib/js/head.min.js"></script><script src="reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
})

// See https://github.com/hakimel/reveal.js#configuration for a full list of configuration options
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: 'true',
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Push each slide change to the browser history
  history: false,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'none',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 960,
  height: 700,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js/plugin/notes/notes.js', async: true },
      
      
      
      
  ],

  

});</script></body></html>